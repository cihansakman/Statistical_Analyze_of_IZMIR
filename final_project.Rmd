---
title: "Final Project"
author: "Cihan"
date: "14 05 2021"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **R Final Project**

> The scope of this project is the enviromental analyze of Izmir from the three datasets generated by the Izmir Municipality (IBB Acik Veri
Portali https://acikveri.bizizmir.com/dataset). In this project we will try to analyze the Water Consumption and Production and The Amount of Food Distriubted for the Animals.

***

## Imports
```{r}
library(ggplot2)
library('stringr')
library(dplyr)
library(ggpubr)
library(moments)

```

***

### Loading Dataset
```{r}
water.consumption <- read.csv("C:\\Users\\sakma\\Desktop\\R Files\\Final Project\\csv_files\\yillik-mahalle-su-tuketimi.csv", header = TRUE, encoding="UTF-8", stringsAsFactors=FALSE,sep=";")

water.binding <- read.csv("C:\\Users\\sakma\\Desktop\\R Files\\Final Project\\csv_files\\su-baglama-sureleri.csv", header = TRUE, encoding="UTF-8", stringsAsFactors=FALSE, sep=";")

water.production <- read.csv("C:\\Users\\sakma\\Desktop\\R Files\\Final Project\\csv_files\\su-uretimi-kaynak-dagilimi.csv", header = TRUE, encoding="UTF-8", stringsAsFactors=FALSE,sep=";")

```

***

Change the column names
```{r}
colnames(water.consumption) <- c("year","month","district","neighborhood","user_count","avg_consumption")
colnames(water.production) <- c("year","month","source","amount_m3")
colnames(water.binding) <- c("year","district","binding_time_day","sub_time_day","explore_time_day","collection_time_day","petition_count")


```

### **Data visualization and descriptive stats**

> Let's see some of data

>- Summarize all three data
```{r echo=FALSE}
paste("Summary of Water Consumption")
summary(water.consumption)
paste("Summary of Water Production")
summary(water.production)
paste("Summary of Water Binding")
summary(water.binding)

```


>There are some mistakes in the data.

1. In **Water Consumption**, *'year'* and *'month'* columns' type should be String, *'avg_consumpiton'* column kept as String and numbers are seperated by **','**. We'll replace these ',' with '.' and convert the type into **float**.

2. In **Water Production**, *'year'* and *'month'* columns' type should be String, *'amount_m3* should kept as **float**.

3. In **Animal Food**, *'year'* and *'month'* columns' type should be String.

4. For all data we convert *'character'* type variable into *'factor'*

```{r echo=TRUE}

water.consumption$avg_consumption <- str_replace_all(water.consumption$avg_consumption , ',', '.')

paste("Edit for Water Consumption")
water.consumption$avg_consumption = as.numeric(as.character(water.consumption$avg_consumption))
water.consumption$year = as.character(as.numeric(water.consumption$year))
water.consumption$month = as.character(as.numeric(water.consumption$month))

names <- c('year' ,'month', 'district','neighborhood')
water.consumption[,names] <- lapply(water.consumption[,names] , factor)
paste("Summary for Water Production after Edit")
sapply(water.consumption, summary)

##############

paste("Edit for Water Production")
water.production$amount_m3 = as.numeric(as.character(water.production$amount_m3))
water.production$year = as.character(as.numeric(water.production$year))
water.production$month = as.character(as.numeric(water.production$month))

names <- c('year' ,'month', 'source')
water.production[,names] <- lapply(water.production[,names] , factor)
paste("Summary for Water Production after Edit")
sapply(water.production, summary)

#############
paste("Edit for Water Binding")

water.binding$binding_time_day <- str_replace_all(water.binding$binding_time_day , ',', '.')
water.binding$sub_time_day <- str_replace_all(water.binding$sub_time_day , ',', '.')
water.binding$explore_time_day <- str_replace_all(water.binding$explore_time_day , ',', '.')
water.binding$collection_time_day <- str_replace_all(water.binding$collection_time_day , ',', '.')

water.binding$binding_time_day = as.numeric(as.character(water.binding$binding_time_day))
water.binding$sub_time_day = as.numeric(as.character(water.binding$sub_time_day))
water.binding$explore_time_day = as.numeric(as.character(water.binding$explore_time_day))
water.binding$collection_time_day = as.numeric(as.character(water.binding$collection_time_day))

names <- c('year' ,'district')
water.binding[,names] <- lapply(water.binding[,names] , factor)

paste("Summary for Water Binding after Edit")
head(water.binding,20)
sapply(water.binding, summary)

```



### Let's take the Water Consumption of 2020 and show the most 5 consumer districts in Izmir
- Subset the values which are belong the 2020 and summarize the data.
- Create a new feature that refers total consumption rather than average consumption

**Note:** Due to values are huge for total consumption we'll take the (m^3) / (10^3)
```{r message = FALSE, warning=FALSE}
consumption.2020 = subset(water.consumption, subset = water.consumption$year == 2020)
#Created a new feature called consumption which refers total consumption
consumption.2020$consumption_in_month <- paste((consumption.2020$avg_consumption * consumption.2020$user_count) / 10**3 )
consumption.2020$consumption_in_month = as.numeric(as.character(consumption.2020$consumption_in_month))
head(consumption.2020,10)
summary(consumption.2020)
```


- Show the most consumer districts.
```{r  message = FALSE, warning=FALSE}
#We can see the most consumer districts in 2020 in Izmir.
df1 <- consumption.2020 %>% 
  group_by(district) %>% 
  summarize(total_consumption = sum(consumption_in_month))

df1 <- df1 %>%
  arrange(desc(total_consumption))

df1 %>% tbl_df %>% print(n=40)

df1 <- df1 %>% slice_max(total_consumption, n = 5)


```



- Top 5 consumer districts in Izmir
```{r}
p<-ggplot(data=df1, aes(x=reorder(district, -total_consumption), y=total_consumption)) +
  geom_bar(stat="identity", fill="orange")

p <- p + labs(title = "Most 5 Consumer Districts", x='District', y='Total Consumption(m^3/10^3)')
p


```

### Let's take the most two consumer in 2020 and compare them(Buca and Karabağlar)
```{r  message = FALSE, warning=FALSE}
top.two.consumer = subset(consumption.2020, subset = consumption.2020$district == "BUCA" | consumption.2020$district == "KARABAĞLAR" )
summary(top.two.consumer)
## Be sure about taking the Buca and Karabağlar
unique(top.two.consumer[c("district")])
```

- Let's see how many neighborhoods does districts have 
```{r  message = FALSE, warning=FALSE}
p <- top.two.consumer %>% 
     group_by(district) %>% 
     summarise(n=n_distinct(neighborhood)) %>%
     ggplot(., aes(x=district, y=n)) +
            geom_bar(stat='identity',fill="#d896ff")


p + labs(title = "Count of Neighborhoods for Districts", x='District', y='Count of Neighborhoods')
```

**Note:** It seems that Buca has less neighborhoods but the water consuming in Buca higher than Karabağlar.

- Let's see the mean water consumption for each month 


```{r  message = FALSE, warning=FALSE, echo=FALSE}
top.two.consumer$month = as.numeric(as.character(top.two.consumer$month))
summary_data <- tapply(top.two.consumer$consumption_in_month, list(months = top.two.consumer$month,
                                       districts = as.character(top.two.consumer$district)),
                       FUN = mean, na.rm = TRUE)
summary_data

```

**Note:** It seems that there are some mistakes in data for 4th and 5th months.

**Is water consumption correlated with user count of districts?**


- Show the most crowded districts.
```{r  message = FALSE, warning=FALSE}
#We can see the most consumer districts in 2020 in Izmir.
df <- consumption.2020 %>% 
  group_by(district) %>% 
  summarize(total_user = sum(user_count))

df <- df %>%
  arrange(desc(total_user))

df %>% tbl_df %>% print(n=40)

df <- df %>% slice_max(total_user, n = 5)

```

- Take a closer look at most crowded districts and most consumer districts.
```{r}

p1<-ggplot(data=df, aes(x=reorder(district, -total_user), y=total_user)) +
  geom_bar(stat="identity", fill="orange")

p1 <- p1 + labs(title = "Most 5 Crowded Districts", x='District', y='Total User in a Year')



p2<-ggplot(data=df1, aes(x=reorder(district, -total_consumption), y=total_consumption)) +
  geom_bar(stat="identity", fill="orange")

p2 <- p2 + labs(title = "Most 5 Consumer Districts", x='District', y='Total Consumption(m^3/10^3)')

ggarrange(p1, p2, ncol =1, nrow = 2)



```

- Let's see how consumption changes with the number of users.

```{r}

p <- ggplot(data=consumption.2020, aes(x=consumption_in_month, y=user_count))  + geom_point() 
p + labs(title = "Change of Consumpiton With User Count", x='Avg Consumption', y='User Count')
cor(consumption.2020$consumption_in_month,consumption.2020$user_count)
```

**Note:** We can clearly see from the above plot there is a linear correlation between user counts and water consumption. Now let's visualize the data and see the shape of it.

```{r}
base.plot <- ggplot(consumption.2020, aes(x = consumption_in_month)) +
  xlab("consumption_in_month") 


p1 <- base.plot + geom_histogram()
p2 <- base.plot + geom_boxplot()
p3 <- base.plot + geom_density()


ggarrange(p1, p2, p3, ncol =2, nrow = 2, labels = c( "Geom Histogram","Boxplot","Density"))

#It seems that we have a right skewed data. Let's see the skewness rate of the data
skewness(consumption.2020$consumption_in_month, na.rm = TRUE)
```



- We'll have square root(double) transform for transform right skewed data to normally distributed data.

```{r}
consumption.2020.transform <- transform(consumption.2020, 
            consumption_in_month = sqrt(sqrt(consumption_in_month)))
            


base.plot <- ggplot(consumption.2020.transform, aes(x = consumption_in_month)) +
  xlab("consumption_in_month") 


p1 <- base.plot + geom_histogram()
p2 <- base.plot + geom_boxplot()
p3 <- base.plot + geom_density()


ggarrange(p1, p2, p3, ncol =2, nrow = 2, labels = c( "Geom Histogram","Boxplot","Density"))

#It seems that we did a good job and transformed the data to normally distributed. Now take look at skewness rate again
skewness(consumption.2020.transform$consumption_in_month, na.rm = TRUE)



p <- ggplot(data=consumption.2020.transform, aes(x=consumption_in_month, y=user_count))  + geom_point() 
p + labs(title = "Change of Consumpiton With User Count", x='Avg Consumption', y='User Count')

#Now take a look for correlation between water consumption and user count after making data normally distriubted
cor(consumption.2020.transform$consumption_in_month,consumption.2020$user_count)

#It's still seem that there is high correlation between consumption and user count
```


### **Confidence Intervals**

#### Let's take the Water Consumption of 2020 and compare the consumption based on winter and summer

**Note:** Don't forget that we're working on the transformed data!

- First we'll categorize the months and just looking at the winter and summer
```{r}
consumption.2020.transform$month = as.numeric(as.character(consumption.2020.transform$month))
consumption.2020.transform$seasons = cut(consumption.2020.transform$month,c(0,2,5,8,11,12))
levels(consumption.2020.transform$seasons) = c("winter","spring","summer","autumn","winter")
#select(consumption.2020, month, seasons)

#subset the winter and summer
winter.vs.summer = subset(consumption.2020.transform, subset = consumption.2020.transform$seasons == "winter" | consumption.2020.transform$seasons == "summer" )
summary(winter.vs.summer)

qplot(x = seasons, y = consumption_in_month,
      geom = "boxplot", data = winter.vs.summer,
      xlab = "Seasons", 
      ylab = "Consumption in m3 / 10^3",
      fill = I("lightblue"))
```

**The boxplot suggest that winter is associated with less water consumption.**


Let's compute a summary table and see it better. *(Don't forget that these values are transformed)*

```{r}

#data.for.summary.table <- transform(winter.vs.summer, 
 #           consumption_in_month = (consumption_in_month)**4)
            


#aggregate(consumption_in_month ~ seasons, 
        #  data = data.for.summary.table, 
        #  FUN = function(x) {c(mean = mean(x), sd = sd(x))})

aggregate(consumption_in_month ~ seasons, 
          data = winter.vs.summer, 
          FUN = function(x) {c(mean = mean(x), sd = sd(x))})
```

**Now the summary table shows the difference significantly We shouldn't forget that the consumption_in_month represents (m^3^ / 10^3^). It means that we should multiply the values with 1000 to access real m^3^ values of water consumption.(Also these values are transformed) **


```{r}
#Mean for consumption_in_month(m^3 / 1000)
mean(winter.vs.summer$consumption_in_month)
```

**We assume that we don't have an information about the population varience and we'll use the t-score for calculating Confidence Intervals**

Let's take the winter and summer one by one and compare their Confidence Intervals

```{r}
winter = subset(winter.vs.summer, subset = winter.vs.summer$seasons == "winter")
summer = subset(winter.vs.summer, subset = winter.vs.summer$seasons == "summer")


#Confidence Interval of Winter consumption_in_month(m^3 / 1000)
winter.CI <- t.test(winter$consumption_in_month)$conf.int
winter.CI

#Confidence Interval of Summer consumption_in_month(m^3 / 1000)
summer <- t.test(summer$consumption_in_month)$conf.int
summer
```

**Note:** We took the 0.95 Confidence Intervals of water consumption in Summer and Winter. And we can see that the confidence intervals are not overlapping and Water consumption in Summer and Winter are significantly different from each ohters.


Now let's test our hypothesis using Welch Two Sample t-test

**Ho:** Mu winter = Mu summer and **H1:** Mu winter != Mu summer

```{r}
with(winter.vs.summer, t.test(x=consumption_in_month[seasons=="winter"], 
                     y=consumption_in_month[seasons=="summer"]))

```

**Our p-value is less than 0.05(alpha) and also our confidence interval doesn't include 0. That's mean Water Consumption in Winter and Summer significantly different from each others. And we can reject that Mu winter is equal to Mu summer(H0)**

***

# WATER PRODUCTION

***

- Let's see the data again
```{r}
head(water.production,10)
sapply(water.production, summary)

```

**Note:** There are no sufficiant information about the water production of 2021. Therefore we'll dismiss it.
```{r}
water.production = subset(water.production, subset = water.production$year != "2021")
sapply(water.production, summary)

```
- Take a look at the most productive Sources
```{r}
#We can see the most consumer districts in 2020 in Izmir.
df1 <- water.production %>% 
  group_by(source) %>% 
  summarize(total_amount = sum(amount_m3))

df1 <- df1 %>%
  arrange(desc(total_amount))

df1 %>% tbl_df %>% print(n=40)

```


- Top 5 productive sources in Izmir
```{r  message = FALSE, warning=FALSE}
df1 <- df1 %>% slice_max(total_amount, n = 5)
p<-ggplot(data=df1, aes(x=reorder(source, -total_amount), y=total_amount)) +
  geom_bar(stat="identity", fill="orange")

p <- p + labs(title = "Most 5 Productive Sources", x='Source', y='Total Produce(m^3)')
p
```

#### It seems that the most productive source is Tahtali Baraji.

Let's take a look how the water production changes year by yea in Tahtali Baraji.

-First take the Tahtali Baraji's data.

**Note:** amount_m3 divided by 1000 to see the numbers better.
```{r}
water.production.tahtali = subset(water.production, subset = water.production$source == "Tahtalı Barajı")
water.production.tahtali$amount_m3 = water.production.tahtali$amount_m3 / 10**3
sapply(water.production.tahtali, summary)

p<-ggplot(data=water.production.tahtali, aes(x=year, y=amount_m3)) +
  geom_bar(stat="identity", fill="orange")

p



```

Histograms of Water Production in Tahtali
```{r}
par(mfrow = c(2,3)) # Display plots in a single 2 x 2 figure 
plot(water.production.tahtali$amount_m3)
with(water.production.tahtali, hist(amount_m3))
with(water.production.tahtali, boxplot(amount_m3))
plot(water.production.tahtali$amount_m3, water.production.tahtali$year)
qqnorm(water.production.tahtali$amount_m3)
qqline(water.production.tahtali$amount_m3)
plot(density(water.production.tahtali$amount_m3))

#hist(flu$age, right = FALSE, breaks = seq(0,102,2), col = "firebrick", las = 1, xlab = "Age at death (yrs)", ylab = "Frequency", main = "")

```

**Note:** It seems that we have bimodal distribution. It means that there should be different classes. Therefore we'll divide our data into two groups: *Water Consumpiton Before 2015* and *Water Consumption After 2015* and then we'll plot again.

```{r}
water.production.tahtali$year = as.numeric(as.character(water.production.tahtali$year))
water.production.tahtali$seasons = cut(water.production.tahtali$year,c(2008,2014,2020))
levels(water.production.tahtali$seasons) = c("before_2015","after_2015")

#Divide data into two different classes. before.2015 and after.2015
tahtali.before.2015 =subset(water.production.tahtali, subset = water.production.tahtali$seasons == "before_2015")
tahtali.after.2015 =subset(water.production.tahtali, subset = water.production.tahtali$seasons == "after_2015")


par(mfrow= c(1,2))
plot(density(tahtali.before.2015$amount_m3), main = "Before 2015")
plot(density(tahtali.after.2015$amount_m3), main="After 2015")



par(mfrow = c(2,2)) # Display plots in a single 2 x 2 figure 
with(tahtali.before.2015, hist(amount_m3),main = "Water Prod. Tahtali Before 2015")
with(tahtali.before.2015, boxplot(amount_m3),main = "Water Prod. Tahtali Before 2015")
qqnorm(tahtali.before.2015$amount_m3)
qqline(tahtali.before.2015$amount_m3)
plot(density(tahtali.before.2015$amount_m3),main = "Water Prod. Tahtali Before 2015")
shapiro.test(tahtali.before.2015$amount_m3)

par(mfrow = c(2,2)) # Display plots in a single 2 x 2 figure 
with(tahtali.after.2015, hist(amount_m3),main = "Water Prod. Tahtali After 2015")
with(tahtali.after.2015, boxplot(amount_m3),main = "Water Prod. Tahtali After 2015")
qqnorm(tahtali.after.2015$amount_m3)
qqline(tahtali.after.2015$amount_m3)
plot(density(tahtali.after.2015$amount_m3),main = "Water Prod. Tahtali After 2015")
shapiro.test(tahtali.after.2015$amount_m3)
```

**Note:** After that point *Water Production in Tahtali After 2015* seems normally distributed by the above plots and also from the Shapiro Test. Our p value > 0.05 and that's mean we can not reject that data are not significantly different from normal distribution, but *Water Production in Tahtali Before 2015* doesn't look like normally distributed and we'll assume that both of them are normally distributed.


###Let's compare the Confidence Intervals.

- Our confidince coefficient is 0.95 it's mean that our sample means are appear between Confidince Interval by 95%.

- Confidence Interval of Water Production Before 2015 in Tahtali Baraji
```{r}
before.2015.CI <- t.test(tahtali.before.2015$amount_m3)$conf.int
before.2015.CI
```

For the Water Production in Tahtali Baraji before 2015, 95% of the sample means between the 5291.162 and 5717.806. If we transformed the data again that's mean %95 percentage of the sample means between  5291000.162 m3  and 5717000.806 m3 water.


- Confidence Interval of Water Production After 2015 in Tahtali Baraji.
```{r}
after.2015.CI <- t.test(tahtali.after.2015$amount_m3)$conf.int
after.2015.CI
```

For the Water Production in Tahtali Baraji after 2015, 95% of the sample means between the 7075.987 7557.701. If we transformed the data again that's mean %95 percentage of the sample means between 7075000.987 m3 and 7557000.701 m3 water.

***

**Note:** Confidence intervals suggest that the Water Production between *Before 2015* and *After 2015* are significantly different from each others.

***

Now let's test our hypothesis using Welch Two Sample t-test

**Ho:** Mu before_2015 = Mu after_2015 and **H1:** Mu before_2015 != Mu after_2015

```{r}
with(water.production.tahtali, t.test(x=amount_m3[seasons=="before_2015"], 
                     y=amount_m3[seasons=="after_2015"]))

```

**Our p-value is less than 0.05(alpha) and also our confidence interval doesn't include 0. That's mean Water Production after 2015 and before 2015 are significantly different from each others. And we can reject that Mu before_2015 is equal to Mu after_2015(H0). Also we can conclude that from the Confidence Intervals, Tahtali Baraji is much more productive after 2015.**



***

# WATER BINDING

***

- Let's see the data again
```{r}
head(water.binding,10)
sapply(water.binding, summary)

```


### Visualize the data

- Let's take a closer look to binding time. We can explore the shape of the data and also check for the outliers
```{r}
#boxplot(birthwt$birthwt.grams~birthwt$hypertension)


qplot(x =year, y = binding_time_day,
      geom = "boxplot", data = water.binding,
      xlab = "Year", 
      ylab = "Binding Times in Days",
      fill = I("lightblue"))
```

We can see the above boxplot explain the binding times for years. It suggest that in 2020 binding requires less time than other years and it's more symetric than others and narrower than others that is mean that standard deviation of 2020 is a bit smaller than others(Binding time doesn't change a lot). Also in 2019 it seems that the median is also same with in 2020 but the boxplot is wider that is mean the binding time changes much.
 
- Also plot the violin plot and density functions to see the difference better.
```{r}
base.plot <- ggplot(water.binding, aes(x = year, y = binding_time_day)) +
  xlab("Year") +
  ylab("Binding Times in (day)")
# Violin plot
p1 <- base.plot + geom_violin()



#Density functions
base.plot <- ggplot(water.binding, aes(x = binding_time_day)) +
  xlab("Binding Time (day)")
p2 <- base.plot + geom_density(aes(fill = year), alpha = 0.5)

ggarrange(p1, p2, ncol =1, nrow = 2, labels = c( "Violing Histogram","Density"))

```

As we can see from above plots our three data are right skewed but the it suggest us that the 2020 has the less binding time.

- Let's discover the correlation between binding time and exploring time.
```{r}


p <- ggplot(data=water.binding, aes(x=binding_time_day, y=explore_time_day))  + geom_point() 
p + labs(title = "Change of Subscriber Request With Water Binding Time", x='Binding Time in Days', y='Subscriber Request ')


ggscatter(water.binding, x = "binding_time_day", y = "explore_time_day", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Bindin Time (day)", ylab = "Explore Time")


```

From above plots the Pearson coefficient correlation is 0.62. We can not say there is a high correlation but also can not say there is no correlation between them.

Let's viusalize the histograms and try to see the shape of Binding Time and Exploring Time

```{r}

p1 <- ggplot(water.binding, aes(y = binding_time_day)) 
# Violin plot
p1 <- p1 + geom_boxplot(fill=I("lightblue"))


p2 <- ggplot(water.binding, aes(y = explore_time_day))
# Violin plot
p2 <- p2 + geom_boxplot(fill=I("lightblue"))

ggarrange(p1, p2, ncol =1, nrow = 2, labels = c( "Binding Time (day)","Exploring Time (day)"))


p1 <- ggplot(water.binding, aes(x = binding_time_day)) +
  xlab("Binding Times in (day)")
# Violin plot
p1 <- p1 + geom_histogram(fill="orange")


p2 <- ggplot(water.binding, aes(x = explore_time_day)) +
  xlab("Exploring Times in (day)")
# Violin plot
p2 <- p2 + geom_histogram(fill="orange")

ggarrange(p1, p2, ncol =1, nrow = 2, labels = c( "Binding Time (day)","Exploring Time (day)"))




```


It seems that both *Binding Time* and *Exploring Time* are right-skewed. Let's try to transform them with log transform then visualize them again
```{r}
water.binding.log <- transform(water.binding, 
            binding_time_day = log(binding_time_day),
            explore_time_day = log(explore_time_day)
            
            )

p1 <- ggplot(water.binding, aes(x = binding_time_day)) +
  xlab("Binding Time in (day)")
# Violin plot
p1 <- p1 + geom_density(fill="orange")


p2 <- ggplot(water.binding.log, aes(x = binding_time_day)) +
  xlab("Binding Times in (day)")
# Violin plot
p2 <- p2 + geom_density(fill="orange")

p3 <- ggplot(water.binding, aes(sample = binding_time_day)) + ylab("Binding Times in (day)") +
  stat_qq() +
  stat_qq_line()

p4 <- ggplot(water.binding.log, aes(sample = binding_time_day)) + ylab("Binding Times in (day)") +
  stat_qq() +
  stat_qq_line()

ggarrange(p1, p2, p3, p4, ncol =2, nrow = 2, labels = c( "Before Transform","After Transform",
                                                 "Before Transform","After Transform"))

shapiro.test(water.binding.log$binding_time_day)




p1 <- ggplot(water.binding, aes(x = explore_time_day)) +
  xlab("Explore Time in (day)")
# Violin plot
p1 <- p1 + geom_density(fill="orange")


p2 <- ggplot(water.binding.log, aes(x = explore_time_day)) +
  xlab("Explore Times in (day)")
# Violin plot
p2 <- p2 + geom_density(fill="orange")

p3 <- ggplot(water.binding, aes(sample = explore_time_day)) + ylab("Explore Times in (day)") +
  stat_qq() +
  stat_qq_line()

p4 <- ggplot(water.binding.log, aes(sample = explore_time_day)) + ylab("Explore Times in (day)") +
  stat_qq() +
  stat_qq_line()

ggarrange(p1, p2, p3, p4, ncol =2, nrow = 2, labels = c( "Before Transform","After Transform",
                                                 "Before Transform","After Transform"))
shapiro.test(water.binding.log$explore_time_day)

```

It seems that after transformation *Explore Time* value became more normally distributed and *Binding Time* seems still skewed but we'll assume that both data are normally distributed.


- Let's take a look at subscriber petition in last three years
```{r}
p1 <- ggplot(water.binding, aes(sample = petition_count)) + ylab("Request") +
  stat_qq() +
  stat_qq_line()

p2 <- ggplot(water.binding, aes(y = petition_count)) +
  xlab("Request")
# Violin plot
p2 <- p2 + geom_boxplot(fill=I("lightblue"))

p3 <- ggplot(water.binding, aes(x = petition_count)) +
  xlab("Request")
# Violin plot
p3 <- p3 + geom_density(fill=I("lightblue"))

ggarrange(p1, p2, p3, ncol =3, nrow = 1, labels = c( "Before Transform","Before Transform",
                                                 "Before Transform"))


petition.log <- transform(water.binding, 
            petition_count = log(petition_count))


p1 <- ggplot(petition.log, aes(sample = petition_count)) + ylab("Request") +
  stat_qq() +
  stat_qq_line()

p2 <- ggplot(petition.log, aes(y = petition_count)) +
  xlab("Request")
# Violin plot
p2 <- p2 + geom_boxplot(fill=I("lightblue"))

p3 <- ggplot(petition.log, aes(x = petition_count)) +
  xlab("Request")
# Violin plot
p3 <- p3 + geom_density(fill=I("lightblue"))

ggarrange(p1, p2, p3, ncol =3, nrow = 1, labels = c( "After Transform","After Transform",
                                                 "After Transform"))
shapiro.test(petition.log$petition_count)
```

Before the transformation our data was right skewed and we try to take log transformation and make it normally distributed but it seems that doesn't work. After that point we'll assume that our data is normally distributed.

- Let's compare the confidence interval of subscriber petition in 2019 and 2020
```{r}

petition.log.2019 <- subset(petition.log, subset = year == "2019")
petition.log.2020 <- subset(petition.log, subset = year == "2020")



petition.log.2019 <- subset(petition.log, subset = year == "2019")


#Confidence Interval of petition of 2019
petition.log.2019.CI <- t.test(petition.log.2019$petition_count)$conf.int
petition.log.2019.CI

#Confidence Interval of petition of 2020
petition.log.2020.CI <- t.test(petition.log.2020$petition_count)$conf.int
petition.log.2020.CI
```

It seems that there is significant difference between petitions in 2019 and 2020. Lets test it and see it better.

- We'll assume that we don't have an information about sample standard deviation then we'll use t-test.

- Mu petition2019 = Mu petition2020 and H1: Mu petition2019 != Mu petition2020
```{r}


with(petition.log, t.test(x=petition_count[year=="2019"], 
                     y=petition_count[year=="2020"]))


```

**According to the Welch Two Sample t-test, our p-value is 0.6425, and also the 95 percent confidence interval contains 0. That is means we can not reject that the true difference in means is equal to 0. In other words, we can not say the petition counts in 2020 and 2019 are significantly different from each other.**